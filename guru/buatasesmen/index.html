<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generator Asesmen Pendidikan</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Configure Tailwind for Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4F46E5', // Indigo 600
                        'secondary': '#10B981', // Emerald 500
                        'background': '#F9FAFB', // Gray 50
                        'danger': '#EF4444',
                        'info': '#3B82F6', // Blue 500
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .ai-result {
            min-height: 200px;
        }
        
        /* FIX: Ensure all text is white when selected */
        .choice-btn.selected {
            background-color: #4F46E5; /* primary */
            color: white; /* This sets the color for all children elements */
            border-color: #4F46E5;
        }

        /* Styling for generated HTML content (in preview) */
        .ai-result h1, .ai-result h2, .ai-result h3 {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .ai-result h1 { font-size: 1.5rem; color: #4F46E5; }
        .ai-result h2 { font-size: 1.25rem; color: #10B981; }
        .ai-result h3 { font-size: 1.1rem; }
        .ai-result table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .ai-result th, .ai-result td {
            border: 1px solid #ccc;
            padding: 0.75rem;
            text-align: left;
        }
        .ai-result th {
            background-color: #f3f4f6;
        }
        .ai-result ul, .ai-result ol {
            padding-left: 20px;
            margin-bottom: 1rem;
        }

        /* FIX: Custom style for disabled buttons to ensure high contrast and readability */
        #generateBtn:disabled {
            background-color: #065F46; /* Emerald 800 - A dark shade to ensure white text is always visible */
            color: white;
            cursor: not-allowed;
            /* Override the default opacity set by Tailwind */
            opacity: 1; 
        }
        
        #downloadBtn:disabled {
            background-color: #1D4ED8; /* Blue 700 - A dark shade of the info color */
            color: white;
            cursor: not-allowed;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-background font-sans min-h-screen p-4 md:p-8">

    <!-- Firebase SDK Imports for Environment Compliance -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // MEMASTIKAN doc, getDoc, setDoc DIIMPORT UNTUK PERSISTENSI API KEY
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        let app;
        let db;
        let auth;
        let userId = 'mock-user-id'; // Fallback

        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication setup
                // Use onAuthStateChanged to reliably get the userId
                const unsubscribe = auth.onAuthStateChanged(user => {
                    if (user) {
                        userId = user.uid;
                        // Expose globally after auth is ready
                        window.db = db;
                        window.auth = auth;
                        window.userId = userId;
                        // FIX: Expose Firestore functions globally
                        window.doc = doc; 
                        window.getDoc = getDoc;
                        window.setDoc = setDoc;
                        // Trigger API key loading if main script is ready
                        if (window.loadApiKey) {
                            window.loadApiKey();
                        }
                    } else if (initialAuthToken) {
                        signInWithCustomToken(auth, initialAuthToken)
                            .then(userCredential => {
                                userId = userCredential.user.uid;
                                window.db = db;
                                window.auth = auth;
                                window.userId = userId;
                                // FIX: Expose Firestore functions globally
                                window.doc = doc; 
                                window.getDoc = getDoc;
                                window.setDoc = setDoc;
                                if (window.loadApiKey) window.loadApiKey();
                            })
                            .catch(error => {
                                console.error("Custom token sign-in failed:", error);
                                signInAnonymously(auth);
                            });
                    } else {
                        signInAnonymously(auth)
                            .then(userCredential => {
                                userId = userCredential.user.uid;
                                window.db = db;
                                window.auth = auth;
                                window.userId = userId;
                                // FIX: Expose Firestore functions globally
                                window.doc = doc; 
                                window.getDoc = getDoc;
                                window.setDoc = setDoc;
                                if (window.loadApiKey) window.loadApiKey();
                            })
                            .catch(error => {
                                console.error("Anonymous sign-in failed:", error);
                            });
                    }
                });
                // Clean up listener when necessary, though not strictly needed in this context
                // window.onbeforeunload = unsubscribe; 
            } else {
                console.warn("Firebase config not available. Running in mock mode.");
                // Expose mock variables
                window.db = null;
                window.auth = null;
                window.userId = 'mock-user-id';
                // Mock functions to avoid crashing the second script
                window.doc = () => { throw new Error('Firestore not initialized'); };
                window.getDoc = async () => ({ exists: () => false });
                window.setDoc = async () => {};
            }
        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
        }
        
    </script>
    
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 flex items-center justify-center">
                <i data-lucide="brain-circuit" class="w-8 h-8 mr-3 text-primary"></i>
                Generator Asesmen
                <!-- Tombol kunci API dipindahkan ke bawah -->
            </h1>
            <p class="text-gray-500 mt-2">Buat asesmen berdasarkan alur tujuan pembelajaran dan profil lulusan yang ingin dicapai.</p>
            <div id="userIdDisplay" class="mt-2 text-xs text-gray-400">User ID: Loading...</div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 1. Input Section (Mobile: full width, Desktop: 1/3) -->
            <div class="lg:col-span-1 card bg-white p-6 rounded-xl border border-gray-200 h-full flex flex-col">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="file-text" class="w-5 h-5 mr-2 text-primary"></i>
                    Konten Pembelajaran (Input)
                </h2>
                
                <p class="text-sm text-gray-600 mb-3">Isi keempat kolom di bawah untuk memberikan konteks lengkap kepada AI.</p>

                <!-- 1. Mata Pelajaran -->
                <label for="mataPelajaranInput" class="block text-sm font-medium text-gray-700 mt-2">1. Mata Pelajaran (Contoh: IPA)</label>
                <input type="text" id="mataPelajaranInput" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-100" value="Ilmu Pengetahuan Alam (IPA)">

                <!-- 2. Jenjang -->
                <label for="jenjangInput" class="block text-sm font-medium text-gray-700 mt-3">2. Jenjang (Contoh: SD Kelas IV)</label>
                <input type="text" id="jenjangInput" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-100" value="Sekolah Dasar Kelas IV">

                <!-- 3. Alur Tujuan Pembelajaran -->
                <label for="alurTujuanTextarea" class="block text-sm font-medium text-gray-700 mt-3">3. Alur Tujuan Pembelajaran (ATP) <span class="text-xs font-normal text-danger">(Minimal 100 Karakter)</span></label>
                <textarea id="alurTujuanTextarea" rows="7" class="w-full p-3 border border-gray-300 rounded-lg text-sm bg-gray-100 mt-1" placeholder="Daftar tujuan/kompetensi yang harus dicapai siswa...">
Materi: Siklus Air
1. Siswa dapat menjelaskan empat tahapan utama siklus air (evaporasi, kondensasi, presipitasi, infiltrasi).
2. Siswa dapat membuat diagram sederhana siklus air dan melabeli setiap tahapan.
3. Siswa dapat menganalisis dampak aktivitas manusia (misalnya, penebangan hutan) terhadap siklus air lokal.</textarea>
                
                <p id="inputStatus" class="text-xs text-danger mt-1 hidden">⚠️ Alur Tujuan Pembelajaran terlalu pendek (minimal 100 karakter).</p>

                <!-- 4. Dimensi Profil Lulusan -->
                <label for="dimensiProfilTextarea" class="block text-sm font-medium text-gray-700 mt-3">4. Dimensi Profil Lulusan (Contoh: Bernalar Kritis, Mandiri)</label>
                <textarea id="dimensiProfilTextarea" rows="3" class="w-full p-3 border border-gray-300 rounded-lg text-sm bg-gray-100 mt-1" placeholder="Dimensi profil lulusan yang ingin dicapai...">Bernalar Kritis (fokus pada kemampuan menganalisis masalah lingkungan), Mandiri (fokus pada kemampuan mengelola tugas proyek).</textarea>
                
            </div>

            <!-- 2. Action Section & Results (Mobile: full width, Desktop: 2/3) -->
            <div class="lg:col-span-2 flex flex-col gap-8">
                
                <!-- Assessment Choices -->
                <div class="card bg-white p-6 rounded-xl border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="zap" class="w-5 h-5 mr-2 text-secondary"></i>
                        Pilih Jenis Asesmen
                    </h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <!-- Choice Buttons -->
                        <button class="choice-btn p-4 border border-primary/20 rounded-lg text-left hover:bg-primary/5 transition duration-300" data-type="Diagnostik">
                            <p class="font-bold text-primary">1. Asesmen Diagnostik</p>
                            <p class="text-sm text-gray-600">Menguji prasyarat pengetahuan, kesiapan belajar & gaya belajar.</p>
                        </button>
                        <button class="choice-btn p-4 border border-primary/20 rounded-lg text-left hover:bg-primary/5 transition duration-300" data-type="AsLearning">
                            <p class="font-bold text-primary">2. Assessment as Learning (AaL)</p>
                            <p class="text-sm text-gray-600">Alat refleksi dan pemantauan diri untuk siswa (Jurnal).</p>
                        </button>
                        <!-- UPDATED DESCRIPTION -->
                        <button class="choice-btn p-4 border border-primary/20 rounded-lg text-left hover:bg-primary/5 transition duration-300" data-type="ForLearning">
                            <p class="font-bold text-primary">3. Assessment for Learning (AfL)</p>
                            <p class="text-sm text-gray-600">Alat formatif cepat untuk guru (Kuis, Rubrik Observasi, Tiket Keluar).</p>
                        </button>
                        <button class="choice-btn p-4 border border-primary/20 rounded-lg text-left hover:bg-primary/5 transition duration-300" data-type="OfLearning">
                            <p class="font-bold text-primary">4. Assessment of Learning (AoL)</p>
                            <p class="text-sm text-gray-600">Ujian sumatif akhir unit (penentuan nilai).</p>
                        </button>
                    </div>

                    <!-- NEW BUTTON LAYOUT: Generate Button and API Key Button side-by-side -->
                    <div class="flex space-x-4">
                        <button id="generateBtn" onclick="generateAssessment()" class="flex-grow bg-secondary text-white font-bold py-3 rounded-xl hover:bg-secondary/90 transition duration-300 flex items-center justify-center" disabled>
                            <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i>
                            <span id="buttonText">Pilih Jenis Asesmen di Atas</span>
                        </button>
                        <!-- Tombol Kunci API dipindahkan di sini -->
                        <button id="apiKeyBtn" onclick="openApiKeyModal()" class="flex-shrink-0 p-3 bg-gray-100 text-gray-400 border border-gray-300 rounded-xl hover:bg-gray-200 hover:text-primary transition duration-300" title="Gunakan Kunci API Kustom">
                            <i data-lucide="key" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <div id="loadingIndicator" class="hidden mt-4 text-center text-primary font-medium">
                        <i data-lucide="loader" class="w-5 h-5 inline-block animate-spin mr-2"></i>
                        AI sedang Menganalisis & Membuat Asesmen...
                    </div>
                </div>

                <!-- Result Section -->
                <div class="card bg-white p-6 rounded-xl border border-gray-200 flex-grow">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="scroll-text" class="w-5 h-5 mr-2 text-primary"></i>
                        Hasil Generasi Asesmen (Didukung Gemini)
                    </h2>
                    
                    <div id="resultContainer" class="ai-result border border-dashed border-gray-300 bg-gray-50 p-4 rounded-lg text-gray-700 text-sm overflow-auto">
                        Hasil asesmen akan muncul di sini setelah Anda menekan tombol "Buat Asesmen".
                    </div>

                    <button id="downloadBtn" onclick="downloadAssessment()" class="mt-4 w-full bg-info text-white font-bold py-2 rounded-xl hover:bg-info/90 transition duration-300 flex items-center justify-center" disabled>
                        <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                        Unduh Sebagai Dokumen HTML (.html)
                    </button>
                    
                    <div id="statusMessage" class="mt-4 text-xs text-gray-500"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- API Key Modal Structure (UPDATED) -->
    <div id="apiKeyModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4 transition-opacity duration-300" onclick="closeApiKeyModal(event)">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full card shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <i data-lucide="key-round" class="w-6 h-6 mr-3 text-primary"></i>
                Kunci API Gemini
            </h2>
            <p class="text-gray-600 mb-6 text-sm">Pilih kunci API yang akan digunakan untuk membuat asesmen. Pilihan yang Anda simpan akan menjadi default.</p>
            
            <!-- Key Selection Choices -->
            <div class="space-y-4 mb-6">
                <!-- Token 1 (Fixed Key) -->
                <div class="flex items-start">
                    <input id="keyChoiceToken1" type="radio" name="apiKeyChoice" value="token1" class="h-4 w-4 text-primary border-gray-300 focus:ring-primary mt-1" checked onchange="toggleCustomKeyInput()">
                    <label for="keyChoiceToken1" class="ml-3 block text-sm font-medium text-gray-700">
                        Token 1 (Direkomendasikan)
                        <p class="text-xs text-gray-500 font-normal mt-0.5">Menggunakan kunci bawaan yang disediakan.</p>
                    </label>
                </div>

                <!-- Custom Key Input -->
                <div class="flex items-start">
                    <input id="keyChoiceCustom" type="radio" name="apiKeyChoice" value="custom" class="h-4 w-4 text-primary border-gray-300 focus:ring-primary mt-1" onchange="toggleCustomKeyInput()">
                    <label for="keyChoiceCustom" class="ml-3 block text-sm font-medium text-gray-700">
                        Kunci API Kustom
                        <p class="text-xs text-gray-500 font-normal mt-0.5">Masukkan kunci API Gemini Anda sendiri di bawah ini.</p>
                    </label>
                </div>
            </div>

            <!-- Custom Key Input Field (Conditional visibility) -->
            <div id="customKeySection" class="mb-6">
                <label for="customApiKeyInput" class="block text-sm font-medium text-gray-700 mb-2">Masukkan Kunci Kustom Anda:</label>
                <input type="password" id="customApiKeyInput" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-primary focus:border-primary bg-gray-100 disabled:opacity-75" placeholder="Masukkan kunci API kustom Anda di sini...">
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeApiKeyModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-300 font-medium">Batal</button>
                <button onclick="saveApiKey()" class="px-4 py-2 text-white bg-primary rounded-lg hover:bg-primary/90 transition duration-300 font-medium flex items-center" id="saveApiKeyBtn">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                    Simpan & Gunakan
                </button>
            </div>
            <p id="apiKeyStatus" class="mt-3 text-xs text-secondary hidden">✅ Pilihan kunci API berhasil disimpan.</p>
        </div>
    </div>
    <!-- End API Key Modal Structure -->


    <!-- Advertisement Pop-up Modal Structure -->
    <div id="adModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center p-4 transition-opacity duration-300" style="opacity: 0;">
        <div class="bg-white rounded-xl p-2 max-w-lg w-full card shadow-2xl relative" onclick="event.stopPropagation()">
            
            <!-- Tombol Tutup (Pojok Kanan Atas) -->
            <button id="topCloseAdBtn" disabled class="absolute top-2 right-2 p-2 rounded-full bg-black bg-opacity-70 text-white flex items-center justify-center transition duration-300 opacity-50 cursor-not-allowed z-10" title="Tombol Tutup Akan Aktif dalam 5 Detik">
                <i data-lucide="lock" class="w-4 h-4"></i>
                <span id="adCountdown" class="ml-1 text-xs font-extrabold">5</span>s
            </button>
            
            <!-- Gambar Placeholder (Ganti dengan URL GitHub Anda) -->
            <img id="adImage" 
                 src="https://placehold.co/600x400/4F46E5/ffffff?text=Iklan+Promosi+Pendidikan" 
                 alt="Iklan Promosi" 
                 class="w-full h-auto rounded-lg"
                 onerror="this.onerror=null;this.src='https://placehold.co/600x400/4F46E5/ffffff?text=Gambar+Tidak+Tersedia';"
            />
            
        </div>
    </div>
    <!-- End Advertisement Pop-up Modal Structure -->

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // --- DOM Elements ---
        const mataPelajaranInput = document.getElementById('mataPelajaranInput');
        const jenjangInput = document.getElementById('jenjangInput');
        const alurTujuanTextarea = document.getElementById('alurTujuanTextarea');
        const dimensiProfilTextarea = document.getElementById('dimensiProfilTextarea');

        const resultContainer = document.getElementById('resultContainer');
        const generateBtn = document.getElementById('generateBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const statusMessage = document.getElementById('statusMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const inputStatus = document.getElementById('inputStatus');
        const downloadBtn = document.getElementById('downloadBtn');
        
        // API Key Modal Elements (UPDATED)
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyBtn = document.getElementById('apiKeyBtn'); 
        const keyChoiceToken1 = document.getElementById('keyChoiceToken1');
        const keyChoiceCustom = document.getElementById('keyChoiceCustom');
        const customKeySection = document.getElementById('customKeySection');
        const customApiKeyInput = document.getElementById('customApiKeyInput');
        const apiKeyStatus = document.getElementById('apiKeyStatus'); 

        // Ad Modal elements
        const adModal = document.getElementById('adModal');
        const topCloseAdBtn = document.getElementById('topCloseAdBtn'); 
        const adCountdown = document.getElementById('adCountdown');
        
        // --- State Variables ---
        let selectedAssessmentType = null;
        let latestGeneratedText = ""; // Stores the raw HTML output from Gemini
        const MIN_CHARS = 100; // Minimum characters for the ATP content
        
        // --- Gemini API Key State ---
        const TOKEN_ONE_KEY = 'AIzaSyAPedPdcIK3mDXUDNjAm6vZaWfS1x0SotY';
        let activeKeyType = 'token1'; // Default to Token 1
        let savedCustomKey = ""; // The actual key string if custom is selected
        let activeKey = TOKEN_ONE_KEY; // The key currently used for API calls

        // --- Constants for Gemini API ---
        const defaultApiKey = ""; // Default empty key, now only used if 'activeKey' is empty.
        
        // Function to determine which API key to use
        function getApiKey() {
            // Priority: activeKey (from selection) > defaultApiKey (empty string)
            return activeKey || defaultApiKey;
        }

        // System Instruction
        const SYSTEM_INSTRUCTION = "Anda adalah Ahli Kurikulum dan Pedagogi di Indonesia. Tugas Anda adalah menghasilkan instrumen asesmen. OUTPUT WAJIB BERUPA KODE HTML MURNI (gunakan tag <h1>, <h2>, <p>, <ul>, <table>, <ol> dan <li> untuk struktur). MULAI SEGERA DENGAN JUDUL UTAMA ASESMEN (misal: <h1>Asesmen Diagnostik</h1>) TANPA INTRODUKSI, PENGANTAR, atau CATATAN PEMBUKA dari persona Anda.";
        
        
        // --- CORE FIREBASE & INIT FUNCTIONS ---

        // Function to wait for window.userId to be ready (populated by the module script)
        function waitForFirebaseAuth() {
            return new Promise(resolve => {
                const check = setInterval(() => {
                    // Cek apakah fungsi Firestore dan userId sudah tersedia
                    if (window.userId && window.userId !== 'mock-user-id' && window.doc) {
                        clearInterval(check);
                        resolve();
                    }
                }, 100);
            });
        }

        // Helper to set the currently active key for API calls
        function updateActiveKey() {
            if (activeKeyType === 'token1') {
                activeKey = TOKEN_ONE_KEY;
                // Update button icon to show 'lock' (indicating a specific, set key)
                apiKeyBtn.innerHTML = '<i data-lucide="lock" class="w-6 h-6"></i>'; 
            } else if (activeKeyType === 'custom' && savedCustomKey.length > 10) {
                activeKey = savedCustomKey;
                // Update button icon to show 'lock'
                apiKeyBtn.innerHTML = '<i data-lucide="lock" class="w-6 h-6"></i>'; 
            } else {
                // Fallback to default empty key if custom key is invalid
                activeKey = defaultApiKey; 
                // Update button icon to show 'key' (indicating default/no custom key)
                apiKeyBtn.innerHTML = '<i data-lucide="key" class="w-6 h-6"></i>'; 
            }
            lucide.createIcons();
            console.log(`Active Key Type Set: ${activeKeyType}. Key length: ${activeKey.length}`);
        }

        // Load API Key from Firestore
        window.loadApiKey = async function() {
            try {
                await waitForFirebaseAuth();

                userIdDisplay.textContent = `User ID: ${window.userId}`;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                const apiKeyRef = window.doc(window.db, `artifacts/${appId}/users/${window.userId}/settings/api_key`);
                const docSnap = await window.getDoc(apiKeyRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.keyType) {
                        activeKeyType = data.keyType;
                        console.log(`Loaded Key Type: ${activeKeyType}`);
                    }

                    if (data.customKey && data.customKey.length > 10) {
                        savedCustomKey = data.customKey;
                        console.log("Custom API Key string loaded from Firestore.");
                    }
                }
                
                // Initialize active key after loading state
                updateActiveKey(); 

            } catch (error) {
                console.error("Failed to load API key state from Firestore:", error);
                // Ensure default is set if loading fails
                activeKeyType = 'token1';
                updateActiveKey();
            }
        }
        
        // Call loadApiKey and openAdModal on window load
        window.onload = function() {
            window.loadApiKey();
            checkInputLength();
            openAdModal(); // Membuka pop-up iklan saat halaman dimuat
        }

        // --- ADVERTISEMENT MODAL FUNCTIONS (UNCHANGED) ---
        let countdownTimer;

        function openAdModal() {
            // Reset state for the new button
            topCloseAdBtn.disabled = true;
            topCloseAdBtn.classList.add('opacity-50', 'cursor-not-allowed');
            topCloseAdBtn.classList.remove('hover:bg-red-500', 'bg-opacity-90');
            topCloseAdBtn.title = "Tombol Tutup Akan Aktif dalam 5 Detik";
            
            // Update button content to show lock and countdown
            topCloseAdBtn.innerHTML = `
                <i data-lucide="lock" class="w-4 h-4"></i>
                <span id="adCountdown" class="ml-1 text-xs font-extrabold">5</span>s
            `;
            lucide.createIcons();
            
            // Display modal
            adModal.classList.remove('hidden');
            setTimeout(() => adModal.style.opacity = '1', 10);
            
            let seconds = 5;
            const countdownSpan = document.getElementById('adCountdown');
            if (countdownSpan) countdownSpan.textContent = seconds;
            
            // Start countdown
            countdownTimer = setInterval(() => {
                seconds--;
                const currentCountdownSpan = document.getElementById('adCountdown');
                if (currentCountdownSpan) currentCountdownSpan.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(countdownTimer);
                    enableAdCloseButton();
                }
            }, 1000);
        }

        function enableAdCloseButton() {
            topCloseAdBtn.disabled = false;
            topCloseAdBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            topCloseAdBtn.classList.add('bg-opacity-90', 'hover:bg-red-500'); 
            topCloseAdBtn.title = "Tutup Iklan";
            
            // Update content to show only the X icon
            topCloseAdBtn.innerHTML = `<i data-lucide="x" class="w-4 h-4"></i>`;
            lucide.createIcons();
            
            topCloseAdBtn.onclick = closeAdModal; // Set the click handler once enabled
        }

        function closeAdModal() {
            if (countdownTimer) clearInterval(countdownTimer);
            adModal.style.opacity = '0';
            setTimeout(() => {
                adModal.classList.add('hidden');
            }, 300);
        }
        // --- END ADVERTISEMENT MODAL FUNCTIONS ---


        // --- GENERAL UTILITY FUNCTIONS ---

        function checkInputLength() {
            const atpLength = alurTujuanTextarea.value.trim().length;
            const mpValid = mataPelajaranInput.value.trim().length > 0;
            const jenjangValid = jenjangInput.value.trim().length > 0;
            const dplValid = dimensiProfilTextarea.value.trim().length > 0;
            const atpValid = atpLength >= MIN_CHARS;

            if (!atpValid) {
                inputStatus.classList.remove('hidden');
            } else {
                inputStatus.classList.add('hidden');
            }

            generateBtn.disabled = !(selectedAssessmentType && mpValid && jenjangValid && dplValid && atpValid);
        }

        // Add event listeners for all content inputs
        mataPelajaranInput.addEventListener('input', checkInputLength);
        jenjangInput.addEventListener('input', checkInputLength);
        alurTujuanTextarea.addEventListener('input', checkInputLength);
        dimensiProfilTextarea.addEventListener('input', checkInputLength);


        function getAssessmentTitle(type) {
            switch (type) {
                case 'Diagnostik': return 'Diagnostik';
                case 'AsLearning': return 'As Learning (AaL)';
                case 'ForLearning': return 'For Learning (AfL)';
                case 'OfLearning': return 'Of Learning (AoL)';
                default: return '';
            }
        }

        function getPrompt(type) {
            const mp = mataPelajaranInput.value.trim();
            const jenjang = jenjangInput.value.trim();
            const atp = alurTujuanTextarea.value.trim();
            const dpl = dimensiProfilTextarea.value.trim();
            
            // Construct the full context block to send to Gemini
            const fullContext = `
                <p><strong>Mata Pelajaran:</strong> ${mp}</p>
                <p><strong>Jenjang:</strong> ${jenjang}</p>
                <h2>Alur Tujuan Pembelajaran:</h2>
                <ul>
                    <li>${atp.replace(/\n/g, '</li><li>')}</li>
                </ul>
                <h2>Dimensi Profil Lulusan:</h2>
                <p>${dpl}</p>
            `;

            // Base query requesting HTML output
            const baseQuery = `Berdasarkan konteks pembelajaran di bawah ini, berikan hasilnya dalam format HTML murni. Pastikan output menggunakan tag HTML (<h1>, <h2>, <table>, <p>, <ul>/ol>) dan tidak ada Markdown atau simbol sisa.\n\n### KONTEKS PEMBELAJARAN\n${fullContext}\n\n`;
            
            switch (type) {
                case 'Diagnostik':
                    return `Buatkan asesmen diagnostik lengkap KOSAKATANYA SESUAI DENGAN JENJANG (${jenjang}) yang terdiri dari 3 bagian: 
                    1. 5 pertanyaan pilihan ganda untuk menguji prasyarat pengetahuan (Kognitif).
                    2. MINIMAL 12 PERTANYAN (4 Visual, 4 Auditori, 4 Kinestetik) kuesioner singkat untuk mengidentifikasi gaya belajar (Non-Kognitif).
                    3. MINIMAL 6 PERNYATAAN kuesioner singkat (skala Likert Sederhana: 'Sangat Setuju', 'Setuju', 'Tidak Setuju') untuk menilai Kesiapan Sosial-Emosional siswa (Afektif), meliputi perasaan tentang materi baru, motivasi, dan hubungan sosial di kelas. 
                    
                    Sertakan panduan analisis dan tindak lanjut guru untuk semua bagian. Gunakan istilah 'Dimensi Profil Lulusan'. ${baseQuery}`;
                case 'AsLearning':
                    return `Buatkan kerangka 'Jurnal Refleksi Mandiri' (minimum 3 prompts refleksi diri) yang KOSAKATANYA SESUAI DENGAN JENJANG (${jenjang}), terstruktur, dan kontekstual untuk membantu siswa memantau kemajuan belajarnya (metakognisi). Selain refleksi diri, integrasikan minimal 1 bagian 'Penilaian Sejawat (Peer Assessment)' sederhana jika Dimensi Profil Lulusan mencakup aspek sosial/kolaborasi. Instruksi harus jelas. ${baseQuery}`;
                case 'ForLearning':
                    return `Buatkan RUBRIK OBSERVASI 4 LEVEL (Sangat Baik, Baik, Cukup, Perlu Bimbingan) untuk menilai keterampilan praktik siswa (berdasarkan ATP) dan/atau Dimensi Profil Lulusan. Selain rubrik, buatkan 3 'Exit Tickets' (Tiket Keluar) cepat untuk merangkum materi. Berikan semua dalam format HTML yang terstruktur (menggunakan tag <table> untuk rubrik). ${baseQuery}`;
                case 'OfLearning':
                    return `Buatkan 10 soal asesmen sumatif (Assessment of Learning) yang terstruktur, berupa pilihan ganda 4 opsi. Pastikan 5 soal menguji aplikasi/analisis (C3-C4) dan 5 soal menguji HOTS (C5-C6/Evaluasi) yang terintegrasi dengan Dimensi Profil Lulusan. Sertakan kunci jawaban lengkap dalam format tabel HTML. ${baseQuery}`;
                default:
                    return "Error: Jenis asesmen tidak valid.";
            }
        }

        // Exponential backoff for retrying fetch requests (Unchanged)
        async function retryFetch(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    } else if (response.status === 429) {
                        // Too many requests, retry after delay
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Other non-retryable errors
                        throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                        
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error; // Re-throw on last attempt
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // --- API Key Modal & Firestore Functions (UPDATED) ---
        
        // Toggles visibility and state of the custom key input field
        function toggleCustomKeyInput() {
            const isCustom = keyChoiceCustom.checked;
            customApiKeyInput.disabled = !isCustom;
            customKeySection.classList.toggle('opacity-50', !isCustom);
            customKeySection.classList.toggle('pointer-events-none', !isCustom);
            
            if (isCustom) {
                customApiKeyInput.focus();
                customApiKeyInput.value = savedCustomKey; // Load saved custom key when toggled
            } else {
                customApiKeyInput.value = "";
            }
        }

        function openApiKeyModal() {
            apiKeyModal.classList.remove('hidden');
            apiKeyModal.style.opacity = '0';
            setTimeout(() => {
                apiKeyModal.style.opacity = '1';
            }, 10);
            
            // Set radio button state based on current active type
            if (activeKeyType === 'custom') {
                keyChoiceCustom.checked = true;
            } else {
                keyChoiceToken1.checked = true;
            }
            toggleCustomKeyInput(); // Initialize visibility
            apiKeyStatus.classList.add('hidden');
        }

        function closeApiKeyModal(event) {
            if (event && event.target !== apiKeyModal) return;
            
            apiKeyModal.style.opacity = '0';
            setTimeout(() => {
                apiKeyModal.classList.add('hidden');
            }, 300);
        }

        // Saves the selected key type and custom string to Firestore, and updates activeKey
        async function saveApiKey() {
            const newKeyType = keyChoiceCustom.checked ? 'custom' : 'token1';
            let newCustomKeyString = keyChoiceCustom.checked ? customApiKeyInput.value.trim() : "";
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const apiKeyRef = window.doc(window.db, `artifacts/${appId}/users/${window.userId}/settings/api_key`);
            
            apiKeyStatus.classList.remove('hidden');
            apiKeyStatus.classList.remove('text-secondary', 'text-danger');
            apiKeyStatus.classList.add('text-primary');
            apiKeyStatus.textContent = "Sedang menyimpan...";

            if (!window.db || !window.userId) {
                apiKeyStatus.textContent = "⚠️ Gagal menyimpan. Autentikasi Firebase belum siap.";
                apiKeyStatus.classList.add('text-danger');
                return;
            }

            // Validation for custom key
            if (newKeyType === 'custom' && newCustomKeyString.length < 10) {
                apiKeyStatus.textContent = "⚠️ Kunci API kustom tidak valid atau terlalu pendek (minimal 10 karakter).";
                apiKeyStatus.classList.remove('text-primary');
                apiKeyStatus.classList.add('text-danger');
                return;
            }
            
            try {
                // Save state to Firestore
                await window.setDoc(apiKeyRef, { 
                    keyType: newKeyType, 
                    customKey: newCustomKeyString 
                });
                
                // Update JS state
                activeKeyType = newKeyType;
                savedCustomKey = newCustomKeyString;

                // Update the key used for API calls
                updateActiveKey();

                apiKeyStatus.textContent = `✅ Pilihan berhasil disimpan. Menggunakan: ${newKeyType === 'token1' ? 'Token 1' : 'Kunci Kustom'}.`;
                apiKeyStatus.classList.remove('text-primary');
                apiKeyStatus.classList.add('text-secondary');
                
                setTimeout(closeApiKeyModal, 1500);
                
            } catch (error) {
                console.error("Failed to save API key state to Firestore:", error);
                apiKeyStatus.textContent = "⚠️ Gagal menyimpan kunci API ke Firestore. Coba lagi.";
                apiKeyStatus.classList.remove('text-primary');
                apiKeyStatus.classList.add('text-danger');
            }
        }
        // --- End API Key Modal Functions ---


        // --- Download Function (UNCHANGED) ---
        function downloadAssessment() {
            if (!latestGeneratedText || !selectedAssessmentType) {
                statusMessage.className = 'mt-4 text-sm text-danger font-medium';
                statusMessage.textContent = 'ERROR: Harap buat asesmen terlebih dahulu sebelum mengunduh.';
                return;
            }

            const assessmentTitle = getAssessmentTitle(selectedAssessmentType);
            const contentForDownload = latestGeneratedText;

            const minimalStyle = `
                body { font-family: 'Arial', sans-serif; line-height: 1.6; max-width: 850px; margin: 40px auto; padding: 20px; color: #333; }
                h1 { color: #4F46E5; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 25px; font-size: 24px; }
                h2 { color: #10B981; margin-top: 25px; font-size: 20px; }
                h3 { color: #4F46E5; margin-top: 20px; font-size: 18px; }
                p { margin-bottom: 15px; }
                ul, ol { padding-left: 20px; margin-bottom: 15px; }
                li { margin-bottom: 5px; }
                table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                th { background-color: #f2f2f2; }
                hr { border: 0; border-top: 1px solid #eee; margin: 25px 0; }
            `;

            const documentTitle = `Asesmen_${assessmentTitle}_${new Date().toISOString().slice(0, 10)}`;
            const fullHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${documentTitle}</title>
                    <style>${minimalStyle}</style>
                </head>
                <body>
                    <h1>ASESSMEN GENERATOR AI: ${assessmentTitle}</h1>
                    <p><strong>Tanggal Pembuatan:</strong> ${new Date().toLocaleDateString('id-ID')}</p>
                    <p><strong>Dibuat Berdasarkan Input:</strong> Mata Pelajaran, Jenjang, Alur Tujuan Pembelajaran, dan Dimensi Profil Lulusan.</p>
                    <hr>
                    <div id="assessment-content">
                        ${contentForDownload}
                    </div>
                </body>
                </html>
            `;

            const blob = new Blob([fullHtml], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${documentTitle}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            statusMessage.className = 'mt-4 text-sm text-info font-medium';
            statusMessage.textContent = `⬇️ Berkas ${documentTitle}.html berhasil diunduh. Anda dapat membukanya dengan Google Docs.`;
        }


        // --- Assessment Type Selection (UNCHANGED) ---
        document.querySelectorAll('.choice-btn').forEach(button => {
            button.addEventListener('click', function() {
                // 1. DESELECTION LOGIC (Restore default colors on all other buttons)
                document.querySelectorAll('.choice-btn').forEach(b => {
                    b.classList.remove('selected');
                    // Restore default Tailwind colors
                    b.querySelector('p:first-child').classList.add('text-primary');
                    b.querySelector('p:last-child').classList.add('text-gray-600');
                    // Restore default Tailwind background/hover states
                    b.classList.add('bg-white', 'text-gray-800', 'hover:bg-primary/5');
                });

                // 2. SELECTION LOGIC (Apply selected state to the clicked button)
                this.classList.add('selected');
                // Remove default Tailwind colors so the custom CSS {color: white;} takes effect
                this.querySelector('p:first-child').classList.remove('text-primary');
                this.querySelector('p:last-child').classList.remove('text-gray-600');
                // Remove default Tailwind background/hover states
                this.classList.remove('bg-white', 'text-gray-800', 'hover:bg-primary/5');
                
                selectedAssessmentType = this.dataset.type;
                checkInputLength(); 
                buttonText.textContent = `Buat Asesmen ${getAssessmentTitle(selectedAssessmentType)}`;
            });
        });

        // --- Main Generation Function ---
        async function generateAssessment() {
            const atpValid = alurTujuanTextarea.value.trim().length >= MIN_CHARS;
            const mpValid = mataPelajaranInput.value.trim().length > 0;
            const jenjangValid = jenjangInput.value.trim().length > 0;
            const dplValid = dimensiProfilTextarea.value.trim().length > 0;
            
            if (!selectedAssessmentType || !mpValid || !jenjangValid || !dplValid || !atpValid) {
                statusMessage.className = 'mt-4 text-sm text-danger font-medium';
                statusMessage.textContent = 'ERROR: Harap isi semua kolom dan pastikan Alur Tujuan Pembelajaran mencapai minimal 100 karakter.';
                return;
            }

            // Check if the custom key is selected but empty
            if (activeKeyType === 'custom' && activeKey.length < 10) {
                statusMessage.className = 'mt-4 text-sm text-danger font-medium';
                statusMessage.textContent = 'ERROR: Anda memilih Kunci API Kustom, tetapi kuncinya kosong. Harap masukkan dan simpan kuncinya melalui tombol Kunci API.';
                return;
            }

            const assessmentTitle = getAssessmentTitle(selectedAssessmentType);
            
            // State management
            downloadBtn.disabled = true;
            generateBtn.disabled = true;
            buttonText.textContent = `Membuat ${assessmentTitle}...`;
            loadingIndicator.classList.remove('hidden');
            resultContainer.innerHTML = 'AI sedang memproses Konten Pembelajaran...';
            statusMessage.textContent = '';
            latestGeneratedText = "";
            
            try {
                const userQuery = getPrompt(selectedAssessmentType);

                // Use the key determined by getApiKey()
                const currentApiKey = getApiKey();
                // If the key is an empty string, the environment provides the default key automatically.
                // If the key is TOKEN_ONE_KEY or a custom key, it is included in the URL.
                const dynamicApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentApiKey}`;


                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: SYSTEM_INSTRUCTION }]
                    }
                };

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };
                
                const startTime = Date.now();
                const response = await retryFetch(dynamicApiUrl, options);
                
                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                let generatedText = candidate?.content?.parts?.[0]?.text || "Gagal mendapatkan respons dari AI. Coba lagi atau periksa konten input Anda.";
                
                generatedText = generatedText.replace(/```html\n?/gi, '',).replace(/\n?```/gi, '').trim();


                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                latestGeneratedText = generatedText;
                resultContainer.innerHTML = generatedText;
                downloadBtn.disabled = false;
                
                statusMessage.className = 'mt-4 text-sm text-secondary font-medium';
                statusMessage.textContent = `✅ Asesmen ${assessmentTitle} berhasil dibuat. Waktu proses: ${duration} detik.`;
                
            } catch (error) {
                console.error("Gemini API Error:", error);
                resultContainer.innerHTML = `
                    <div class="text-danger font-bold">Terjadi Kesalahan!</div>
                    <p>Gagal menghubungi atau memproses respons dari AI. Coba lagi. Pastikan Kunci API kustom Anda sudah benar (jika menggunakan kunci kustom).</p>
                `;
                statusMessage.className = 'mt-4 text-sm text-danger font-medium';
                statusMessage.textContent = '❌ Gagal membuat asesmen. Coba lagi.';
            } finally {
                loadingIndicator.classList.add('hidden');
                checkInputLength();
                if (!generateBtn.disabled) {
                    buttonText.textContent = `Buat Asesmen ${getAssessmentTitle(selectedAssessmentType)}`;
                }
            }
        }
        
    </script>
    
</body>
</html>
